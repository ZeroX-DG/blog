<!doctype html>
<html lang="en">
    <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="A quick look into how the browser layout process works.">
    <meta name="author" content="Viet Hung Nguyen">

    <!-- twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Browser from Scratch: Layout">
    <meta name="twitter:description" content="A quick look into how the browser layout process works.">
    <meta name="twitter:creator" content="@ZeroX_Hung">
    <meta name="twitter:image" content="https://zerox-dg.github.io/blog/img/me.jpg">
    <link rel="icon" type="image/x-icon" href="https://github.com/ZeroX-DG.png">
    <title>
      
        Browser from Scratch: Layout
      
    </title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inconsolata&family=EB+Garamond&display=swap">
    <link rel="stylesheet" href="https://afeld.github.io/emoji-css/emoji.css">
    <link rel="stylesheet" href="/blog/css/blog.css">
    <link rel="stylesheet" href="/blog/css/custom-emoji.css">
    <link rel="stylesheet" href="/blog/css/tocbot.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
<link rel="alternate" href="/blog/rss.xml" title="Viet Hung's blog" type="application/rss+xml">
<link rel="stylesheet" href="/blog/css/prism-material-light.css" type="text/css"></head>

    <body>
        <div class="body-container">
            <div class="blog-post">
  <div class="blog-post-container">
    <p class="home-navigator">
        ← <a href="/blog/">All Posts</a>
    </p>
    <h1 class="blog-post-title">
        Browser from Scratch: Layout
    </h1>
    <div class="blog-post-content">
        <p>Oh hello, it’s been a while. Sorry for making you wait but, it’s exhausting to write about such a dry process as building a browser, in an entertaining way…when I’m extremely lazy <i class="em em-troll"></i></p>
<p>But fear not! For the past few months, I’ve carefully studied the teaching of the great sloths to improve my productivity. Thus, I’m pretty confident that the gap between my posts from now on would widen significantly, so you can spend more time with friends and family and not with a depressed code writer who throws his life away, building a browser that barely works <i class="em em-okay"></i></p>
<p>Anyway, enough of my rambling! Let us dive into the dry cold world of browser engineering once more.</p>
<hr>
<p>When life gives the browser a DOM tree &amp; a CSSOM tree, it makes a render tree. Similar to how you were created by mixing your parents’ genes minus some redundant details such as your father’s intelligence or your mother’s good look, combining the DOM tree with the CSSOM tree while filtering out all the nodes that aren’t visible on the page (such as nodes that are <code>display: none</code>) gives you the render tree.</p>
<p>After constructing the render tree, the browser then computes the position of each DOM node in a process called “layout”. Being the most expensive operation in the browser rendering process, nothing wets developers’ pants faster than a long stack of purple layout function calls appearing in the devtool:</p>
<p><img src="https://blog-assets.viethung.space/Browser-from-Scratch-Layout/layoutthrashing.png" /><br><em>A view of layout thrashing from the chrome devtool</em> </p>
<p>This phenomenon has the scientific name of <a href="https://developers.google.com/web/fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing" target="_blank" rel="noopener">“layout thrashing”</a> but, a more common title that circulates among div-centring engineers is: “Now who the f*** added a style update in my <code>setInterval</code> animation loop?”</p>
<p>You see, the layout process is scary not only because nobody knows what the f*** is going on in that black box, but also because it’s quite easy to trigger that process, which, if frequent enough, can make your FPS drop faster than your chemistry exam mark.</p>
<p>The reason for this is because to render a frame, the browser must perform a series of tasks that together is commonly known as a render pipeline:</p>
<p><img src="https://blog-assets.viethung.space/Browser-from-Scratch-Layout/render_pipeline.jpg" /><br><em>A render pipeline</em></p>
<p>Because the render pipeline executes its tasks sequentially, if the layout task takes too long to finish, it ends up blocking all the tasks that come after and could result in the render pipeline not completing within the frame’s time limit, thus, dropping the frame rate.</p>
<p>To put that into perspective. If your desired frame rate is 60 FPS, each frame has roughly 1000ms / 60 ≈ 16.6ms to render. Meaning, within 16ms, the browser has to execute every <code>O(n!)</code> JS function of yours, calculate all the styles from your CSS and computes the position of every node in the render tree, before painting those nodes onto million of pixels of your 4K screen. Now you understand how the render pipeline feels, you barbaric monkeys.</p>
<p>Anyway, to calculate the DOM node’s position, the browser relies on a set of specifications that were written by very smart web developers. I didn’t mean to be sarcastic there. Seriously, hats off to those pioneers who literally defined the web we have today. They’re the reason why you’re reading this post and why I get paid at the end of the month.</p>
<p>Overall, the layout process consists of 4 main steps:</p>
<ol>
<li>Generating box tree/layout tree.</li>
<li>Computing layout boxes positions.</li>
<li>Computing layout boxes sizes.</li>
<li>Repeat steps 2 to 4 for child boxes.</li>
</ol>
<h2 id="Box-tree-Layout-tree-generation"><a href="#Box-tree-Layout-tree-generation" class="headerlink" title="Box tree/Layout tree generation"></a>Box tree/Layout tree generation</h2><p>Each node in the DOM tree generates one or multiple boxes to represent the rectangular areas that the node occupies on the page according to the <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/The_box_model" target="_blank" rel="noopener">box model</a>. These boxes are linked together into a tree structure, which is called a box tree or layout tree.</p>
<p>There are two main types of box, namely, block-level box and inline-level box. The block-level boxes are used for elements that take up the whole width of the parent container (<code>&lt;p&gt;</code> is a good example). While inline-level boxes represent elements that stack together horizontally to form a line. For example <code>&lt;span&gt;</code> or <code>&lt;a&gt;</code>. The rules for generating these boxes are so clear that after reading, you’d find yourself becoming <a href="https://en.wikipedia.org/wiki/The_Thinker" target="_blank" rel="noopener">“The Thinker”</a>. Nude and confused about everything.</p>
<p><img src="https://blog-assets.viethung.space/Browser-from-Scratch-Layout/thinker.jpg" /></p>
<p>But hey, if you want to see box generation works, feel free to dive into <a href="https://www.w3.org/TR/CSS22/visuren.html" target="_blank" rel="noopener">the specification</a>.</p>
<h3 id="Formatting-context"><a href="#Formatting-context" class="headerlink" title="Formatting context"></a>Formatting context</h3><p>When a box is generated, it establishes a formatting context to specify how its child boxes should be laid out. Different layout types have different formatting contexts, but the most popular would certainly be the flow layout with the <strong>Block Formatting Context (BFC)</strong> and the <strong>Inline Formatting Context (IFC)</strong>.</p>
<p>In the BFC, boxes are stacked on top of each other. Thus, the BFC will only be established by a box if its children are block-level boxes. Similarly, boxes in IFC are stacked horizontally, and so every box must be an inline-level box.</p>
<p>But then what if there’s a mixture of inline-level &amp; block-level boxes? What would the holy browser do to eradicate such heresy? Enter anonymous box.</p>
<h3 id="Anonymous-box"><a href="#Anonymous-box" class="headerlink" title="Anonymous box"></a>Anonymous box</h3><p>Let’s say if we have this HTML:</p>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>text<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>text<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>text<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
</code></pre>
<p>Since <code>&lt;div&gt;</code>s are <code>display: block</code>, they generates block-level boxes, and <code>&lt;span&gt;</code>s on the other hand, generates inline-level boxes, the resulting layout tree would look like:</p>
<pre><code>[block-level (div#parent)]
  |- [inline-level (span#1)]
  |- [block-level (div)]
  |    |- [inline-level (span#2)]
  |- [inline-level (span#3)]
</code></pre><p>But rather than having a mixture of inline-level &amp; block-level boxes, the browser always simplifies the structure by breaking it into anonymous wrappers, which are boxes that have no associated DOM node. This way, it ensures that boxes at the same nested level always share the same box type. Therefore, in this situation, the browser would break the above structure into:</p>
<pre><code>[block-level (div#parent)]
  |- [block-level anonymous]
  |    |- [inline-level (span#1)]
  |- [block-level (div)]
  |    |- [inline-level (span#2)]
  |- [block-level anonymous]
  |    |- [inline-level (span#3)]
</code></pre><h2 id="Compute-box-position-amp-size"><a href="#Compute-box-position-amp-size" class="headerlink" title="Compute box position &amp; size"></a>Compute box position &amp; size</h2><p>Once the layout tree has been constructed, the browser travels it to compute the size and position of each box. The algorithm for calculating those properties depends entirely on the layout algorithm. For example, in BFC, the width of each box is the width that you explicitly specified using the CSS property <code>width</code>; otherwise, the width of the parent box is used instead.</p>
<blockquote>
<p>Having experienced death by boredom, I understand how unpleasant the experience can be, but if you enjoy the taste of tedium dripping on your tough while munching the CSS specification, here’s the <a href="https://www.w3.org/TR/CSS22/visudet.html" target="_blank" rel="noopener">link</a> for ya.</p>
</blockquote>
<h1 id="The-end"><a href="#The-end" class="headerlink" title="The end"></a>The end</h1><p>It’s been nearly a year since I started building this browser. I can’t say that I enjoyed the entire journey, but it certainly helped me in many ways. Maybe I’ll have a post about that, maybe I won’t, but in any case, I think this “Browser from Scratch” series should end here, and no, I’m not dropping this browser project. This journey has reached the point where writing about it is no longer enjoyable for me, and I’m pretty sure that it doesn’t make any sense for any of you if you never make a browser yourself. So from now on, I’ll only be writing about the discoveries that I made while developing this browser. Some might help you get a pay raise, some might not, but they will certainly be interesting to read, and hopefully, to write as well.</p>
<p>If you enjoy browser engineering &amp; looking for more content, be sure to check out this <a href="https://github.com/ZeroX-DG/awesome-browser" target="_blank" rel="noopener">curated list of browser engineering resources</a> by me.</p>
<p>じゃあね <i class="em em-wave"></i></p>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><ul>
<li>W3C. 2020. <a href="https://www.w3.org/TR/CSS22/visuren.html" target="_blank" rel="noopener">CSS Visual formatting model</a></li>
<li>W3C. 2020. <a href="https://www.w3.org/TR/CSS22/visudet.html" target="_blank" rel="noopener">CSS Visual formatting model details</a></li>
<li>Ilya Grigorik. 2019. <a href="https://www.w3.org/TR/CSS22/visudet.html" target="_blank" rel="noopener">Render-tree Construction, Layout, and Paint</a></li>
</ul>

    </div>
    <div class="tag-list">
        <b>Tags:</b>
        
            <a href="/blog/tags/code/" class="tag">
                #code
            </a>
        
            <a href="/blog/tags/browser-from-scratch/" class="tag">
                #browser-from-scratch
            </a>
        
    </div>
    <div class="donate">
        <a href="https://ko-fi.com/viethung" class="donate-button">Love what you read? Support me via ko-fi <i class="em em-coffee"></i></a>
    </div>
    <div class="separator"></div>
    <div class="related-blog-post-list">
        <h1 class="title">Other posts</h1>
        
        
        
            <div class="blog-post-item">
  <span class="date">2020-05-29</span>
    <span class="blog-post-title">
        <a href="/blog/Browser-from-Scratch-Introduction/">
          Browser from Scratch: Introduction
        </a>
    </span>
</div>

        
            <div class="blog-post-item">
  <span class="date">2020-09-01</span>
    <span class="blog-post-title">
        <a href="/blog/Browser-from-Scratch-DOM-API/">
          Browser from Scratch: DOM API
        </a>
    </span>
</div>

        
            <div class="blog-post-item">
  <span class="date">2020-10-24</span>
    <span class="blog-post-title">
        <a href="/blog/Browser-from-Scratch-HTML-parsing/">
          Browser from Scratch: HTML parsing
        </a>
    </span>
</div>

        
            <div class="blog-post-item">
  <span class="date">2021-01-13</span>
    <span class="blog-post-title">
        <a href="/blog/Browser-from-Scratch-CSS-parsing-processing/">
          Browser from Scratch: CSS parsing & processing
        </a>
    </span>
</div>

        
            <div class="blog-post-item">
  <span class="date">2023-12-05</span>
    <span class="blog-post-title">
        <a href="/blog/What-is-border-radius-really/">
          What is border-radius, really?
        </a>
    </span>
</div>

        
    </div>
  </div>
  <div class="js-toc"></div>
</div>

        </div>
        <!-- After footer scripts -->
        <script src="/blog/js/tocbot.min.js"></script>
<script src="/blog/js/custom.js"></script>
<script>
 tocbot.init({
     tocSelector: '.js-toc',
     contentSelector: '.blog-post-content',
     headingSelector: 'h1, h2, h3',
 });
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123395923-6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123395923-6');
</script>

    </body>
</html>
